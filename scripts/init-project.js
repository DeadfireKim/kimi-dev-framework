#!/usr/bin/env node
/**
 * KDF Project Initializer v2.0
 * ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ê³  ê¸°ë³¸ êµ¬ì¡°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 * 
 * ì‚¬ìš©ë²•: node init-project.js {project-name} [--tier={lite|pro|scale}]
 */

const fs = require('fs');
const path = require('path');

const KDF_DIR = '.kdf';
const SUBDIRS = [
  'active',
  'backlog/epics',
  'backlog/stories',
  'completed',
  'templates',
  'local'
];

const VALID_TIERS = ['lite', 'pro', 'scale'];

function printUsage() {
  console.log(`
ğŸš€ KDF Project Initializer v2.0

Usage:
  node init-project.js {project-name} [--tier={lite|pro|scale}]

Options:
  --tier     Project tier (default: pro)
             lite  : ê°€ë²¼ìš´ í”„ë¡œì íŠ¸ (ì •ì  ì›¹ì‚¬ì´íŠ¸ ë“±)
             pro   : í‘œì¤€ ì• í”Œë¦¬ì¼€ì´ì…˜ (ê¸°ë³¸ê°’)
             scale : ëŒ€ê·œëª¨ ì‹œìŠ¤í…œ (ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë“±)

Examples:
  node init-project.js my-app --tier=pro
  node init-project.js portfolio --tier=lite
`);
}

function parseArgs(args) {
  const result = {
    projectName: null,
    tier: 'pro'
  };

  for (let i = 0; i < args.length; i++) {
    const arg = args[i];
    
    if (arg.startsWith('--tier=')) {
      const tier = arg.substring(7).toLowerCase();
      if (VALID_TIERS.includes(tier)) {
        result.tier = tier;
      } else {
        console.error(`âŒ Invalid tier: ${tier}`);
        console.error(`   Valid tiers: ${VALID_TIERS.join(', ')}`);
        process.exit(1);
      }
    } else if (!arg.startsWith('--')) {
      result.projectName = arg;
    }
  }

  if (!result.projectName) {
    result.projectName = path.basename(process.cwd());
  }

  return result;
}

function createDirectory(dir) {
  if (!fs.existsSync(dir)) {
    fs.mkdirSync(dir, { recursive: true });
    console.log(`âœ“ Created: ${dir}`);
    return true;
  } else {
    console.log(`âœ“ Exists: ${dir}`);
    return false;
  }
}

function createStatusFile(projectName, tier) {
  const statusPath = path.join(KDF_DIR, 'status.json');
  const now = new Date().toISOString();
  
  const status = {
    version: '2.0.0',
    project: {
      name: projectName,
      tier: tier,
      phase: 'discover',
      current_sprint: null,
      created_at: now
    },
    pdca: {
      current: null,
      stage: null,
      iterations: 0,
      quality_score: 0
    },
    features: [],
    sprints: [],
    epics: [],
    metrics: {
      total_stories: 0,
      completed_stories: 0,
      total_features: 0,
      completed_features: 0,
      average_quality: 0
    },
    last_updated: now
  };
  
  fs.writeFileSync(statusPath, JSON.stringify(status, null, 2));
  console.log(`âœ“ Created: ${statusPath}`);
  return status;
}

function createGitignore() {
  const gitignorePath = path.join(KDF_DIR, '.gitignore');
  const content = `# KDF temporary and local files
*.tmp
*.backup
local/
*.log
`;
  if (!fs.existsSync(gitignorePath)) {
    fs.writeFileSync(gitignorePath, content);
    console.log(`âœ“ Created: ${gitignorePath}`);
  }
}

function createReadme(projectName, tier) {
  const readmePath = path.join(KDF_DIR, 'README.md');
  if (fs.existsSync(readmePath)) return;

  const tierNames = {
    lite: 'Lite (ê°€ë²¼ìš´ í”„ë¡œì íŠ¸)',
    pro: 'Pro (í‘œì¤€ ì• í”Œë¦¬ì¼€ì´ì…˜)',
    scale: 'Scale (ëŒ€ê·œëª¨ ì‹œìŠ¤í…œ)'
  };

  const content = `# KDF: ${projectName}

**í”„ë¡œì íŠ¸ í‹°ì–´**: ${tierNames[tier]}

## ë¹ ë¥¸ ì‹œì‘

\`\`\`
# PDCA ì‚¬ì´í´ ì‹œì‘
/pdca plan {feature-name}

# ìƒíƒœ í™•ì¸
/pdca status

# ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
/pdca next
\`\`\`

## ë¬¸ì„œ êµ¬ì¡°

\`\`\`
.kdf/
â”œâ”€â”€ status.json              # í”„ë¡œì íŠ¸ ìƒíƒœ
â”œâ”€â”€ active/                  # ì§„í–‰ ì¤‘ì¸ ë¬¸ì„œ
â”œâ”€â”€ backlog/
â”‚   â”œâ”€â”€ epics/              # ì—í”½ ëª©ë¡
â”‚   â””â”€â”€ stories/            # ë°±ë¡œê·¸ ìŠ¤í† ë¦¬
â”œâ”€â”€ completed/              # ì™„ë£Œëœ ë¬¸ì„œ
â””â”€â”€ templates/              # í”„ë¡œì íŠ¸ë³„ í…œí”Œë¦¿
\`\`\`

## ëª…ë ¹ì–´

- \`/pdca plan {feature}\` - ê³„íš ìˆ˜ë¦½
- \`/pdca do {feature}\` - ì‹¤í–‰
- \`/pdca check {feature}\` - ì ê²€
- \`/pdca act {feature}\` - ê°œì„ 
- \`/dev review\` - ì½”ë“œ ë¦¬ë·°
- \`/dev retro\` - íšŒê³ 
- \`/agile story {title}\` - ìŠ¤í† ë¦¬ ìƒì„±

---
*Generated by Kimi Dev Framework v2.0*
`;
  
  fs.writeFileSync(readmePath, content);
  console.log(`âœ“ Created: ${readmePath}`);
}

function suggestNextSteps(tier) {
  const steps = {
    lite: [
      '/pdca plan landing-page',
      '/agile story hero-section',
      '/dev review --scope=file'
    ],
    pro: [
      '/pdca plan user-authentication',
      '/agile epic user-management',
      '/agile story login-with-email'
    ],
    scale: [
      '/dev arch api-gateway',
      '/pdca plan service-mesh',
      '/agile epic microservices-core'
    ]
  };

  console.log(`\nğŸ“‹ Suggested next steps for ${tier} tier:`);
  steps[tier].forEach((step, i) => {
    console.log(`   ${i + 1}. ${step}`);
  });
}

function main() {
  const args = process.argv.slice(2);
  
  if (args.includes('--help') || args.includes('-h')) {
    printUsage();
    process.exit(0);
  }

  const { projectName, tier } = parseArgs(args);

  console.log(`\nğŸš€ Initializing KDF Project: ${projectName}`);
  console.log(`   Tier: ${tier.toUpperCase()}`);
  console.log('');

  // Check if already initialized
  if (fs.existsSync(KDF_DIR)) {
    console.log(`âš ï¸  KDF already initialized in this directory.`);
    console.log(`   Use existing configuration or delete .kdf/ to reinitialize.`);
    process.exit(1);
  }

  // Create main directory
  createDirectory(KDF_DIR);

  // Create subdirectories
  SUBDIRS.forEach(subdir => createDirectory(path.join(KDF_DIR, subdir)));

  // Create status file
  const status = createStatusFile(projectName, tier);

  // Create .gitignore
  createGitignore();

  // Create README
  createReadme(projectName, tier);

  console.log(`\nâœ… Project "${projectName}" initialized successfully!`);
  console.log(`   Tier: ${status.project.tier}`);
  console.log(`   Phase: ${status.project.phase}`);
  
  suggestNextSteps(tier);
  
  console.log(`\nğŸ’¡ Tip: Run "/pdca status" to check project status anytime.`);
}

main();
